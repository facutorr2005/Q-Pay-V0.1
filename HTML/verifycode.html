<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificar C√≥digo - Q-Pay</title>
    <link rel="stylesheet" href="../CSS/verifycode.css">
</head>
<body>
    <div class="verify-container">
        <a href="forgot-password.html" class="back-btn">‚Üê</a>
        
        <div class="logo-section">
            <a href="index.html" class="logo">Q-Pay</a>
            <h2 class="title">Verificar C√≥digo</h2>
            <p class="subtitle">Ingresa el c√≥digo de 6 d√≠gitos que enviamos</p>
        </div>

        <div class="sent-to" id="sentTo">
            üìß C√≥digo enviado a: ejemplo@email.com
        </div>

        <div class="success-message" id="successMessage"></div>
        <div class="error-message" id="errorMessage"></div>
        <div class="attempts-warning" id="attemptsWarning"></div>

        <form id="verifyForm">
            <div class="code-input-container">
                <input type="text" class="code-digit" maxlength="1" inputmode="numeric" data-index="0">
                <input type="text" class="code-digit" maxlength="1" inputmode="numeric" data-index="1">
                <input type="text" class="code-digit" maxlength="1" inputmode="numeric" data-index="2">
                <input type="text" class="code-digit" maxlength="1" inputmode="numeric" data-index="3">
                <input type="text" class="code-digit" maxlength="1" inputmode="numeric" data-index="4">
                <input type="text" class="code-digit" maxlength="1" inputmode="numeric" data-index="5">
            </div>

            <div class="timer-container">
                <div class="timer" id="timer">05:00</div>
                <div class="resend-section">
                    ¬øNo recibiste el c√≥digo? 
                    <button type="button" class="resend-btn" id="resendBtn" disabled>
                        Reenviar c√≥digo
                    </button>
                </div>
            </div>

            <button type="submit" class="verify-btn" id="verifyBtn" disabled>
                Verificar C√≥digo
            </button>
        </form>

        <div class="back-to-login">
            ¬øRecordaste tu contrase√±a? <a href="login.html">Volver al login</a>
        </div>
    </div>

    <script>
        const codeDigits = document.querySelectorAll('.code-digit');
        const verifyBtn = document.getElementById('verifyBtn');
        const timerElement = document.getElementById('timer');
        const resendBtn = document.getElementById('resendBtn');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const attemptsWarning = document.getElementById('attemptsWarning');
        const sentTo = document.getElementById('sentTo');
        const verifyForm = document.getElementById('verifyForm');

        let timeLeft = 300; // 5 minutos en segundos
        let timerInterval;
        let attempts = 0;
        const maxAttempts = 3;
        let isVerifying = false;

        // Obtener par√°metros de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const method = urlParams.get('method');
        const contact = urlParams.get('contact');

        // Actualizar el mensaje de "enviado a"
        if (method && contact) {
            const icon = method === 'email' ? 'üìß' : 'üì±';
            const methodText = method === 'email' ? 'email' : 'SMS';
            sentTo.innerHTML = `${icon} C√≥digo enviado por ${methodText} a: ${contact}`;
        }

        // Inicializar timer
        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerElement.textContent = '00:00';
                    timerElement.classList.add('expired');
                    resendBtn.disabled = false;
                    resendBtn.textContent = 'Reenviar c√≥digo';
                    showMessage('errorMessage', 'El c√≥digo ha expirado. Solicita uno nuevo.');
                }
            }, 1000);
        }

        // Funci√≥n para mostrar mensajes
        function showMessage(type, message) {
            hideMessages();
            const messageElement = document.getElementById(type);
            messageElement.textContent = message;
            messageElement.style.display = 'block';
            
            // Auto-ocultar despu√©s de 5 segundos para mensajes de error
            if (type === 'errorMessage') {
                setTimeout(() => {
                    messageElement.style.display = 'none';
                }, 5000);
            }
        }

        function hideMessages() {
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            attemptsWarning.style.display = 'none';
        }

        // Funci√≥n para verificar si el c√≥digo est√° completo
        function isCodeComplete() {
            return Array.from(codeDigits).every(digit => digit.value.trim() !== '');
        }

        // Funci√≥n para obtener el c√≥digo completo
        function getCode() {
            return Array.from(codeDigits).map(digit => digit.value).join('');
        }

        // Funci√≥n para limpiar el c√≥digo
        function clearCode() {
            codeDigits.forEach(digit => {
                digit.value = '';
                digit.classList.remove('filled', 'error', 'success');
            });
            updateVerifyButton();
        }

        // Funci√≥n para actualizar el estado del bot√≥n de verificar
        function updateVerifyButton() {
            if (isCodeComplete() && !isVerifying && timeLeft > 0) {
                verifyBtn.disabled = false;
                verifyBtn.classList.add('ready');
            } else {
                verifyBtn.disabled = true;
                verifyBtn.classList.remove('ready');
            }
        }

        // Funci√≥n para marcar campos con error
        function showError() {
            codeDigits.forEach(digit => {
                digit.classList.add('error');
                setTimeout(() => {
                    digit.classList.remove('error');
                }, 500);
            });
        }

        // Funci√≥n para marcar campos con √©xito
        function showSuccess() {
            codeDigits.forEach(digit => {
                digit.classList.add('success');
            });
        }

        // Manejar input de c√≥digos
        codeDigits.forEach((digit, index) => {
            digit.addEventListener('input', function(e) {
                const value = e.target.value;
                
                // Solo permitir n√∫meros
                if (!/^\d*$/.test(value)) {
                    e.target.value = '';
                    return;
                }
                
                if (value) {
                    this.classList.add('filled');
                    // Mover al siguiente input
                    if (index < codeDigits.length - 1) {
                        codeDigits[index + 1].focus();
                    }
                } else {
                    this.classList.remove('filled');
                }
                
                // Limpiar errores previos
                this.classList.remove('error');
                hideMessages();
                
                updateVerifyButton();
            });

            // Manejar backspace
            digit.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && !this.value && index > 0) {
                    codeDigits[index - 1].focus();
                }
                
                // Permitir pegar c√≥digo completo
                if (e.key === 'v' && (e.ctrlKey || e.metaKey)) {
                    setTimeout(() => {
                        const pastedData = e.target.value;
                        if (/^\d{6}$/.test(pastedData)) {
                            // Distribuir d√≠gitos en los campos
                            Array.from(pastedData).forEach((digit, i) => {
                                if (codeDigits[i]) {
                                    codeDigits[i].value = digit;
                                    codeDigits[i].classList.add('filled');
                                }
                            });
                            updateVerifyButton();
                        }
                    }, 10);
                }
            });

            // Seleccionar todo al hacer focus
            digit.addEventListener('focus', function() {
                this.select();
            });
        });

        // Manejar env√≠o del formulario
        verifyForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (isVerifying || !isCodeComplete() || timeLeft <= 0) {
                return;
            }

            isVerifying = true;
            verifyBtn.classList.add('loading');
            verifyBtn.innerHTML = 'Verificando...<span class="loading-spinner"></span>';
            
            const code = getCode();
            
            try {
                // Simular verificaci√≥n del c√≥digo
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Simular l√≥gica de verificaci√≥n
                // En producci√≥n, esto ser√≠a una llamada a la API
                const isValidCode = code === '123456' || Math.random() > 0.6;
                
                if (isValidCode) {
                    showSuccess();
                    showMessage('successMessage', '¬°C√≥digo verificado correctamente! Redirigiendo...');
                    
                    // Redirigir a la p√°gina de nueva contrase√±a despu√©s de 2 segundos
                    setTimeout(() => {
                        window.location.href = `reset-password.html?token=${btoa(code)}&method=${method}&contact=${contact}`;
                    }, 2000);
                    
                } else {
                    attempts++;
                    showError();
                    
                    if (attempts >= maxAttempts) {
                        showMessage('errorMessage', 'Has excedido el n√∫mero m√°ximo de intentos. Por favor, solicita un nuevo c√≥digo.');
                        clearCode();
                        verifyBtn.disabled = true;
                        codeDigits.forEach(digit => digit.disabled = true);
                    } else {
                        const remainingAttempts = maxAttempts - attempts;
                        showMessage('errorMessage', `C√≥digo incorrecto. Te quedan ${remainingAttempts} intento${remainingAttempts !== 1 ? 's' : ''}.`);
                        
                        if (remainingAttempts === 1) {
                            attemptsWarning.textContent = '‚ö†Ô∏è √öltimo intento disponible. Despu√©s de esto necesitar√°s solicitar un nuevo c√≥digo.';
                            attemptsWarning.style.display = 'block';
                        }
                        
                        // Limpiar c√≥digo despu√©s de un breve delay
                        setTimeout(() => {
                            clearCode();
                            codeDigits[0].focus();
                        }, 1500);
                    }
                }
                
            } catch (error) {
                showMessage('errorMessage', 'Error de conexi√≥n. Por favor, intenta nuevamente.');
            } finally {
                isVerifying = false;
                verifyBtn.classList.remove('loading');
                verifyBtn.textContent = 'Verificar C√≥digo';
                updateVerifyButton();
            }
        });

        // Manejar reenv√≠o de c√≥digo
        resendBtn.addEventListener('click', async function() {
            if (this.disabled) return;
            
            this.disabled = true;
            this.textContent = 'Enviando...';
            
            try {
                // Simular reenv√≠o
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Reiniciar timer
                timeLeft = 300;
                timerElement.classList.remove('expired');
                clearInterval(timerInterval);
                startTimer();
                
                // Reiniciar intentos
                attempts = 0;
                hideMessages();
                
                // Rehabilitar campos si estaban deshabilitados
                codeDigits.forEach(digit => digit.disabled = false);
                
                showMessage('successMessage', '¬°C√≥digo reenviado correctamente!');
                clearCode();
                codeDigits[0].focus();
                
            } catch (error) {
                showMessage('errorMessage', 'Error al reenviar el c√≥digo. Intenta nuevamente.');
            } finally {
                this.textContent = 'Reenviar c√≥digo';
            }
        });

        // Inicializar
        startTimer();
        codeDigits[0].focus();
        
        // Prevenir el env√≠o accidental del formulario
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.activeElement.classList.contains('code-digit')) {
                e.preventDefault();
                if (isCodeComplete()) {
                    verifyForm.dispatchEvent(new Event('submit'));
                }
            }
        });

        // Limpiar timer al salir de la p√°gina
        window.addEventListener('beforeunload', function() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        });
    </script>
</body>
</html>